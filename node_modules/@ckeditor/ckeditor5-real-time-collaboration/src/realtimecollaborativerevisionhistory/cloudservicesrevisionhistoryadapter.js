/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
const _0x4e9d=['listenTo','cloud-services-internal-error:\x20Revision\x20History\x20Service\x20is\x20not\x20connected.','fromVersion','_revisions','getUser','marker','getMany','isBundleUploaded','serverHistory','code','revisionsUpdated','_createCurrentRevision','baseVersion','_lastRequestId','_bufferedUpdates','Users','adapter','length','getOperations','_revisionHistoryService','_fixRevision','has','isConnected','_getLatestVersion','toVersion','plugins','diffData','change:_isPendingUpdate','message','get','authorsIds','setRevisionData','wrongRequestId','updateRevisions','_bufferUpdate','connected','RevisionHistoryService','state','currentRevision','_startingVersion','buildRevisionData','_preventResendingRevisionData','from','size','creatorId','_isPendingUpdate','config','then','getRevision','catch','_revisionTracker','_update','cloud-services-internal-error:\x20Not\x20connected.','_handleReconnectionError','addRevisionData','_waitForServiceReady','getRevisions','setSource','map','connect','authors','type','editor','max','_oldOffset','isEmptyCurrent','_isConnected','connection','_handleRevisionsUpdate','off','collaboration.channelId','addToReconnectionStack','init','RevisionTracker','_revisionDataBuilder','data','affectsData','repository','isEnabled','reconnect','destroy','_domEmitter','sessionId','bind','_fetchMissingUsers','startsWith','_getLatestVersionFromServerOperations','reverse'];(function(_0x2d0f13,_0x4e9d4d){const _0xe95827=function(_0x3b2118){while(--_0x3b2118){_0x2d0f13['push'](_0x2d0f13['shift']());}};_0xe95827(++_0x4e9d4d);}(_0x4e9d,0x121));const _0xe958=function(_0x2d0f13,_0x4e9d4d){_0x2d0f13=_0x2d0f13-0x0;let _0xe95827=_0x4e9d[_0x2d0f13];return _0xe95827;};import{Plugin as _0x269e01}from'ckeditor5/src/core';import{version as _0x8595a}from'ckeditor5/src/utils';import{Users as _0x40a40f}from'ckeditor5-collaboration/src/collaboration-core';import _0x2a3f8e from'../realtimecollaborativeediting/realtimecollaborationclient';import _0x247582 from'../realtimecollaborativeediting/websocketgateway';import _0x548779 from'../realtimecollaborativeediting/sessions';import _0x522e9b from'@ckeditor/ckeditor-cloud-services-collaboration/src/users/user';import _0x35efe8 from'@ckeditor/ckeditor-cloud-services-collaboration/src/revision-history/revisionhistoryservice';import _0x3aa5cf from'@ckeditor/ckeditor-cloud-services-collaboration/src/editor/editorservice';export default class v extends _0x269e01{static get['requires'](){return[_0x247582,_0x2a3f8e,'RevisionTracker',_0x548779,_0x40a40f];}async[_0xe958('0x2f')](){this[_0xe958('0x4c')]=null,this[_0xe958('0x19')]=this[_0xe958('0x25')][_0xe958('0x0')][_0xe958('0x4')](_0xe958('0x30'));const _0x50e8c0=this[_0xe958('0x25')][_0xe958('0x0')][_0xe958('0x4')](_0x2a3f8e),_0x34d63a=_0x50e8c0['serverHistory'],_0x3721c4=this['editor'][_0xe958('0x0')][_0xe958('0x4')](_0x247582),_0x1d0d19=this['editor'][_0xe958('0x15')][_0xe958('0x4')](_0xe958('0x2d'));this[_0xe958('0x52')]=new v[(_0xe958('0xb'))](_0x1d0d19),this[_0xe958('0x19')][_0xe958('0x20')]({'history':_0x34d63a,'getLatestVersion':()=>this[_0xe958('0x56')](),'getCurrentRevisionId':()=>_0x50e8c0[_0xe958('0x39')]});const _0x381f05=this[_0xe958('0x25')][_0xe958('0x15')][_0xe958('0x4')]('cloudServices.bundleVersion')||_0x8595a,_0x3bf279=await _0x3aa5cf[_0xe958('0x46')](_0x3721c4['connection'],_0x381f05);this['_revisionTracker'][_0xe958('0x4f')]={'getRevision':async({revisionId:_0x147031})=>(await this['_waitForServiceReady'](),await this[_0xe958('0x52')][_0xe958('0x17')](_0x147031)),'updateRevisions':async _0x2ab5a1=>{await this[_0xe958('0x1e')]();const _0x1976c4=this[_0xe958('0x19')][_0xe958('0xd')];if(!_0x3bf279||0x1!==_0x2ab5a1[_0xe958('0x50')]||_0x2ab5a1[0x0]['id']!==_0x1976c4['id']){for(const _0x22f719 of _0x2ab5a1)_0x22f719['id']===_0x1976c4['id']&&(_0x22f719[_0xe958('0x28')]=_0x22f719[_0xe958('0x41')]===_0x22f719['toVersion']);return this[_0xe958('0x52')][_0xe958('0x8')](_0x2ab5a1,this['_lastRequestId'])[_0xe958('0x16')](_0x1b5aac=>{this[_0xe958('0x4c')]=_0x1b5aac;})[_0xe958('0x18')](_0x1149bb=>{if(!(it(_0x1149bb)||'400'===_0x1149bb[_0xe958('0x48')]&&void 0x0!==_0x1149bb[_0xe958('0x32')][_0xe958('0x7')]))throw _0x1149bb;for(const _0x4de6b9 of _0x2ab5a1){!this['_revisionTracker'][_0xe958('0x34')][_0xe958('0x17')](_0x4de6b9['id'])||this[_0xe958('0x19')][_0xe958('0x9')](_0x4de6b9['id'],_0x4de6b9,!0x1);}if(it(_0x1149bb))throw _0x1149bb;});}}},this[_0xe958('0x3f')](this[_0xe958('0x52')],_0xe958('0x49'),(_0x3d6b8b,{revisionsData:_0x2f6c9b,requestId:_0x154028})=>{Math[_0xe958('0x26')](..._0x2f6c9b[_0xe958('0x21')](_0x555598=>_0x555598['toVersion']))>this['_getLatestVersionFromServerOperations']()-0x1?this['_getLatestVersion']()[_0xe958('0x16')](()=>{this[_0xe958('0x2b')](_0x2f6c9b,_0x154028);}):this[_0xe958('0x2b')](_0x2f6c9b,_0x154028);});const {revisions:_0x2fb542,requestId:_0x246850}=await this[_0xe958('0x52')][_0xe958('0x22')](_0x3721c4[_0xe958('0x2a')]);_0x3721c4[_0xe958('0x2e')](this),this[_0xe958('0x4c')]=_0x246850,await this[_0xe958('0x3b')](_0x2fb542);for(const _0x3ca224 of _0x2fb542)this[_0xe958('0x19')]['addRevisionData'](_0x3ca224);this['listenTo'](_0x50e8c0,'change:_isConnected',(_0x35aed2,_0x413570,_0x4efbca)=>{_0x4efbca&&(this[_0xe958('0x27')]=_0x50e8c0['_offset'],_0x35aed2[_0xe958('0x2c')]());}),this[_0xe958('0x19')][_0xe958('0x3a')](_0xe958('0x35'))['to'](_0x3721c4,_0xe958('0xc'),_0x197e61=>_0xe958('0xa')===_0x197e61);}async[_0xe958('0x36')](){const _0x4751b6=this[_0xe958('0x25')][_0xe958('0x0')][_0xe958('0x4')](_0x247582),_0x2ccb96=this[_0xe958('0x25')][_0xe958('0x0')]['get'](_0x2a3f8e),_0x4ed30c=async()=>{const _0x32db5a=this['_revisionTracker'][_0xe958('0xd')],_0xd51c55=_0x32db5a['id'],_0x5b0919=_0xd51c55!==_0x2ccb96['sessionId'];if(_0x5b0919){const _0x2f34f1=_0x2ccb96['_offset']-this[_0xe958('0x27')],_0x35f9c9=this['_getLatestVersionFromServerOperations']();this['_revisionTracker'][_0xe958('0x31')]['reInit']();if(_0x32db5a[_0xe958('0x57')]+_0x2f34f1!==_0x35f9c9){const _0x1fc6c8=_0x32db5a[_0xe958('0x41')]+_0x2f34f1,_0xeb9dc6=this[_0xe958('0x25')][_0xe958('0x0')]['get'](_0xe958('0x4e')),_0x2f0670=this['_revisionTracker'][_0xe958('0xf')]({'currentRevision':_0x32db5a,'from':_0x1fc6c8,'to':_0x35f9c9});_0x2f0670['id']=_0x32db5a['id'];const _0x7d8141=_0x2f0670[_0xe958('0x5')][_0xe958('0x21')](_0x155fc1=>_0xeb9dc6['getUser'](_0x155fc1));_0x32db5a[_0xe958('0x1a')]({..._0x2f0670,'authors':_0x7d8141},!0x0),this[_0xe958('0x19')][_0xe958('0x9')](_0x32db5a['id'],_0x2f0670,!0x0);}this[_0xe958('0x19')][_0xe958('0xe')]=_0x35f9c9,(_0x32db5a[_0xe958('0x57')]===_0x32db5a[_0xe958('0x41')]&&!this[_0xe958('0x19')][_0xe958('0x4d')][_0xe958('0x54')](_0xd51c55)&&this[_0xe958('0x19')][_0xe958('0x34')][_0xe958('0x42')]['remove'](_0xd51c55),this['_revisionTracker'][_0xe958('0x4a')](_0x35f9c9));}const {revisions:_0x160871,requestId:_0x372622}=await this[_0xe958('0x52')][_0xe958('0x36')](_0x4751b6[_0xe958('0x2a')],this[_0xe958('0x4c')]);_0x5b0919&&_0x160871[_0xe958('0x50')]>0x0?_0x2ccb96[_0xe958('0x1c')]():(await this[_0xe958('0x3b')](_0x160871),this[_0xe958('0x2b')](_0x160871,_0x372622),this[_0xe958('0x19')]['sendBufferedUpdates']());};return _0x2ccb96[_0xe958('0x29')]?_0x4ed30c():new Promise((_0x515f11,_0x20c030)=>{_0x2ccb96['once']('change:_isConnected',()=>{_0x4ed30c()['then'](_0x515f11)['catch'](_0x20c030);});});}[_0xe958('0x37')](){this[_0xe958('0x38')]&&this[_0xe958('0x38')]['stopListening'](),super[_0xe958('0x37')]();}async[_0xe958('0x1e')](){this[_0xe958('0x52')][_0xe958('0x55')]||await new Promise(_0x5e309f=>{this[_0xe958('0x3f')](this[_0xe958('0x52')],'connected',_0x54e24c=>{_0x54e24c['off'](),_0x5e309f();});});}[_0xe958('0x3d')](){const _0x2cdaad=this[_0xe958('0x25')][_0xe958('0x0')][_0xe958('0x4')](_0x2a3f8e)[_0xe958('0x47')];for(const _0xa5be93 of _0x2cdaad[_0xe958('0x51')]()[_0xe958('0x3e')]())if(_0xe958('0x44')!==_0xa5be93[_0xe958('0x24')]||_0xa5be93[_0xe958('0x33')])return _0xa5be93[_0xe958('0x4b')]+0x1;}['_getLatestVersion'](){const _0x1c78cb=this['editor'][_0xe958('0x0')]['get'](_0x2a3f8e);return new Promise(_0x29ac64=>{_0x1c78cb[_0xe958('0x14')]?_0x1c78cb['once'](_0xe958('0x2'),()=>{_0x29ac64(this[_0xe958('0x3d')]());}):_0x29ac64(this[_0xe958('0x3d')]());});}[_0xe958('0x2b')](_0x1ca93f,_0x23e6c0){const _0x2b1bf4=this[_0xe958('0x19')]['repository'];this[_0xe958('0x4c')]=_0x23e6c0;for(const _0x424726 of _0x1ca93f){const _0x55809c=_0x2b1bf4['getRevision'](_0x424726['id']);if(_0x55809c){if((_0x424726[_0xe958('0x41')]||_0x424726[_0xe958('0x57')])&&(_0x424726[_0xe958('0x1')]=null),_0x55809c===this['_revisionTracker']['currentRevision']){const _0x253ed3=Math[_0xe958('0x26')](_0x55809c['toVersion'],_0x424726['toVersion']),_0x6f9cc7=Math['max'](_0x55809c[_0xe958('0x41')],_0x424726['fromVersion']);let _0x515dba;_0x55809c[_0xe958('0x57')]===_0x424726[_0xe958('0x57')]&&_0x55809c['fromVersion']===_0x424726[_0xe958('0x41')]?(_0x515dba=!0x0,this[_0xe958('0x10')](_0x424726)):_0x424726[_0xe958('0x57')]===_0x253ed3&&_0x424726[_0xe958('0x41')]===_0x6f9cc7?_0x515dba=!0x1:(_0x55809c[_0xe958('0x57')]===_0x253ed3&&_0x55809c['fromVersion']===_0x6f9cc7||this[_0xe958('0x53')]({'revision':_0x55809c,'from':_0x6f9cc7,'to':_0x253ed3}),_0x515dba=!0x0),_0x515dba&&(delete _0x424726[_0xe958('0x41')],delete _0x424726[_0xe958('0x57')],delete _0x424726[_0xe958('0x1')],delete _0x424726['createdAt'],delete _0x424726[_0xe958('0x5')]);}this[_0xe958('0x19')][_0xe958('0x6')](_0x424726),this[_0xe958('0x10')](_0x424726);}else this[_0xe958('0x19')][_0xe958('0x1d')](_0x424726);}const _0x334e7b=_0x2b1bf4[_0xe958('0x1f')]();_0x334e7b[_0xe958('0x3e')]();for(let _0x372ad3=0x0;_0x372ad3<_0x334e7b[_0xe958('0x50')]-0x1;_0x372ad3++){const _0x2cbe35=_0x334e7b[_0x372ad3],_0x15526b=_0x334e7b[_0x372ad3+0x1];if(_0x2cbe35[_0xe958('0x41')]<_0x15526b[_0xe958('0x57')]){const _0x4a768c=_0x15526b[_0xe958('0x57')],_0x41a321=Math[_0xe958('0x26')](_0x4a768c,_0x2cbe35['toVersion']);this[_0xe958('0x53')]({'revision':_0x2cbe35,'from':_0x4a768c,'to':_0x41a321});}}}[_0xe958('0x53')]({revision:_0x31aae6,from:_0x5a7c01,to:_0x42a9bf}={}){const _0x4d6358=this['editor'][_0xe958('0x0')][_0xe958('0x4')](_0xe958('0x4e')),_0x1dc5db=this['_revisionTracker'][_0xe958('0xf')]({'revision':_0x31aae6,'from':_0x5a7c01,'to':_0x42a9bf});_0x1dc5db[_0xe958('0x23')]=_0x1dc5db['authorsIds']['map'](_0x59c442=>_0x4d6358[_0xe958('0x43')](_0x59c442)),_0x31aae6[_0xe958('0x1a')](_0x1dc5db);}['_preventResendingRevisionData'](_0xf6d9d5){const _0x5ec896={};_0x5ec896['id']=_0xf6d9d5['id'];for(const _0x11fe43 of Object['keys'](_0xf6d9d5))'id'!==_0x11fe43&&(_0x5ec896[_0x11fe43]=void 0x0);this[_0xe958('0x19')][_0xe958('0x9')](_0x5ec896['id'],_0x5ec896,!0x0);}async[_0xe958('0x3b')](_0x2e8f90){const _0x37bec4=this[_0xe958('0x25')][_0xe958('0x0')][_0xe958('0x4')](_0x40a40f),{connection:_0x17a509}=this['editor']['plugins'][_0xe958('0x4')](_0x247582),_0xf29c5b=new Set();for(const _0x27552f of _0x2e8f90){for(const _0xf3eb5a of _0x27552f[_0xe958('0x5')])_0x4176f2(_0xf3eb5a);_0x27552f[_0xe958('0x13')]&&_0x4176f2(_0x27552f[_0xe958('0x13')]);}if(0x0===_0xf29c5b[_0xe958('0x12')])return;const _0x384581=await _0x522e9b[_0xe958('0x45')](_0x17a509,Array[_0xe958('0x11')](_0xf29c5b));for(const _0x3d26b8 of _0x384581)_0x37bec4[_0xe958('0x43')](_0x3d26b8['id'])||_0x37bec4['addUser'](_0x3d26b8);function _0x4176f2(_0x27f7d4){_0x37bec4['getUser'](_0x27f7d4)||_0xf29c5b['add'](_0x27f7d4);}}}function it(_0x5a3d00){return _0x5a3d00['message'][_0xe958('0x3c')](_0xe958('0x40'))||_0x5a3d00[_0xe958('0x3')][_0xe958('0x3c')](_0xe958('0x1b'))||_0x5a3d00[_0xe958('0x3')][_0xe958('0x3c')]('cloud-services-internal-error:\x20Request\x20timeout.');}v[_0xe958('0xb')]=_0x35efe8;