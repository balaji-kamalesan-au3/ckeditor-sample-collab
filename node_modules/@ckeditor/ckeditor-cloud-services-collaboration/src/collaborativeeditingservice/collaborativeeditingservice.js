/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';var __importDefault=this&&this['__importDefault']||function(_0x3964cd){return _0x3964cd&&_0x3964cd['__esModule']?_0x3964cd:{'default':_0x3964cd};};Object['defineProperty'](exports,'__esModule',{'value':!0x0}),exports['_SERVICE']=void 0x0;const uuid_1=require('uuid'),utils_1=require('ckeditor5/src/utils'),messagescompressor_1=__importDefault(require('./../messagescompressor')),sessions_1=__importDefault(require('./../sessions/sessions')),collaborativeeditingconnectmessage_1=__importDefault(require('./messages/collaborativeeditingconnectmessage')),collaborativeeditingupdatemessage_1=__importDefault(require('./messages/collaborativeeditingupdatemessage')),collaborativeeditingreconnectmessage_1=__importDefault(require('./messages/collaborativeeditingreconnectmessage')),collaborativeeditingresponse_1=__importDefault(require('./responses/collaborativeeditingresponse')),collaborativeeditingconnectresponse_1=__importDefault(require('./responses/collaborativeeditingconnectresponse')),websocketgateway_1=__importDefault(require('./../websocketgateway/websocketgateway')),ckeditorcloudserviceserror_1=__importDefault(require('../ckeditorcloudserviceserror')),ServiceNotConnectedError_1=__importDefault(require('../errors/ServiceNotConnectedError')),getdocumentdetailsresponse_1=__importDefault(require('./responses/getdocumentdetailsresponse')),getdocumentdetailsmessage_1=__importDefault(require('./messages/getdocumentdetailsmessage'));exports['_SERVICE']=0x1;class CollaborativeEditingService{constructor(_0x59e87a,_0x2c9468){if(!_0x59e87a)throw new TypeError('Param\x20\x22bundleVersion\x22\x20must\x20be\x20provided.');this['_id']=null!=_0x2c9468?_0x2c9468:(0x0,uuid_1['v4'])(),this['_isConnected']=!0x1,this['_bundleVersion']=_0x59e87a;}['getId'](){return this['_id'];}['isConnected'](){return this['_isConnected'];}['connect'](_0x1729db,_0x331da8={'buffers':[],'types':[]},_0x2df24d){const _0x35f109=new collaborativeeditingconnectmessage_1['default'](this['getId'](),_0x331da8['buffers'],_0x331da8['types'],this['_bundleVersion'],_0x2df24d);return this['_connect'](_0x1729db,_0x35f109);}['reconnect'](_0x3beaf1,_0x4d761c){if(this['isConnected']())throw new ckeditorcloudserviceserror_1['default']('Cannot\x20reconnect\x20to\x20already\x20connected\x20service.',_0x3beaf1);return this['_connect'](_0x3beaf1,new collaborativeeditingreconnectmessage_1['default'](this['getId'](),_0x4d761c,this['_bundleVersion']));}['disconnect'](){this['_isConnected']&&(this['_isConnected']=!0x1,this['_wsGateway']&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_connectedSessions']&&(this['_connectedSessions']['disconnect'](),this['_connectedSessions']=void 0x0),this['fire']('disconnected'),this['stopListening']());}async['getDocumentDetails'](){const _0x115660=new getdocumentdetailsmessage_1['default'](this['getId']());if(!this['_wsGateway'])throw new ServiceNotConnectedError_1['default']('Collaborative\x20Editing',this);const _0x19cd4c=await this['_wsGateway']['_sendRequest'](exports['_SERVICE'],getdocumentdetailsmessage_1['default']['TYPE'],messagescompressor_1['default']['encode'](_0x115660));return messagescompressor_1['default']['decode'](_0x19cd4c,getdocumentdetailsresponse_1['default']);}async['sendOperations'](_0x3545ef,_0x2dd20e,_0x332134){if(!_0x3545ef||!_0x3545ef['types']||!_0x3545ef['types']['length'])throw new ckeditorcloudserviceserror_1['default']('Cannot\x20send\x20empty\x20update.',this['_wsGateway']);const _0x502e32='number'==typeof _0x2dd20e?_0x2dd20e:parseInt(_0x2dd20e);if(!Number['isInteger'](_0x502e32)||_0x502e32<0x0)throw new ckeditorcloudserviceserror_1['default']('Base\x20version\x20not\x20provided.',this['_wsGateway']);const _0x2256a3=new collaborativeeditingupdatemessage_1['default'](this['getId'](),_0x3545ef['buffers'],_0x3545ef['types'],_0x502e32,[],_0x332134);if(!this['_wsGateway']||!this['_isConnected'])throw new ServiceNotConnectedError_1['default']('Collaborative\x20Editing',this);const _0x4143bb=await this['_wsGateway']['_sendRequest'](exports['_SERVICE'],collaborativeeditingupdatemessage_1['default']['TYPE'],messagescompressor_1['default']['encode'](_0x2256a3));return messagescompressor_1['default']['decode'](_0x4143bb,collaborativeeditingresponse_1['default']);}async['getConnectedSessions'](){if(!this['_isConnected'])throw new ServiceNotConnectedError_1['default']('Collaborative\x20Editing',this);return this['_connectedSessions']||(this['_connectedSessions']=await sessions_1['default']['getConnectedSessions'](this['_wsGateway'],this['_id'],exports['_SERVICE'])),this['_connectedSessions'];}static['getConnectedSessions'](_0x1d3151,_0x28ed6c){return sessions_1['default']['getConnectedSessions'](_0x1d3151,_0x28ed6c,exports['_SERVICE']);}async['_connect'](_0x139497,_0x5cc4d2){if(this['isConnected']())return;if(_0x139497['state']!==websocketgateway_1['default']['STATE_CONNECTED'])throw new ckeditorcloudserviceserror_1['default']('WebSocket\x20Gateway\x20is\x20not\x20connected.',_0x139497);this['_wsGateway']=_0x139497,this['stopListening'](_0x139497,'change:state');const _0x4b886a=await _0x139497['_sendRequest'](exports['_SERVICE'],_0x5cc4d2['constructor']['TYPE'],messagescompressor_1['default']['encode'](_0x5cc4d2)),_0x3bf566=messagescompressor_1['default']['decode'](_0x4b886a,collaborativeeditingconnectresponse_1['default']);return this['listenTo'](_0x139497,'change:state',(_0x1c5d55,_0x13f84b,_0x34e6fd)=>this['_onWsGatewayStateChange'](_0x34e6fd),{'priority':websocketgateway_1['default']['_CHANGE_STATE_EVENT_PRIORITY']}),this['_connectToChannel'](_0x139497,_0x3bf566['channel']),this['_isConnected']=!0x0,this['fire']('connected'),_0x3bf566;}['_connectToChannel'](_0x4dbea0,_0x47d5f6){this['_channel']=_0x4dbea0['_getChannel'](exports['_SERVICE'],_0x47d5f6),this['listenTo'](this['_channel'],this['_channel']['getEventName'](collaborativeeditingupdatemessage_1['default']['TYPE']),(_0x3dd7c9,_0x206fec)=>{const _0x2b898d=messagescompressor_1['default']['decode'](_0x206fec,collaborativeeditingupdatemessage_1['default']);this['fire']('operationsReceived',_0x2b898d['baseVersion'],_0x2b898d['data'],_0x2b898d['metadata']);});}['_onWsGatewayStateChange'](_0x15d0ee){_0x15d0ee===websocketgateway_1['default']['STATE_DISCONNECTED']&&this['disconnect']();}}CollaborativeEditingService['_SERVICE']=exports['_SERVICE'],(0x0,utils_1['mix'])(CollaborativeEditingService,utils_1['EmitterMixin']),exports['default']=CollaborativeEditingService;