/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';var __importDefault=this&&this['__importDefault']||function(_0x456912){return _0x456912&&_0x456912['__esModule']?_0x456912:{'default':_0x456912};};Object['defineProperty'](exports,'__esModule',{'value':!0x0});const utils_1=require('ckeditor5/src/utils'),sessions_1=require('./sessions'),user_1=__importDefault(require('./../users/user')),websocketgateway_1=__importDefault(require('./../websocketgateway/websocketgateway')),sessionsconnectresponse_1=__importDefault(require('./responses/sessionsconnectresponse')),sessionsconnectmessage_1=__importDefault(require('./messages/sessionsconnectmessage')),socketconnectmessage_1=__importDefault(require('./messages/socketconnectmessage')),socketdisconnectmessage_1=__importDefault(require('./messages/socketdisconnectmessage')),messagescompressor_1=__importDefault(require('./../messagescompressor'));class SessionCollection extends utils_1['Collection']{constructor(_0x173114,_0x3b3f0b){super({'idProperty':'id'}),this['_id']=_0x173114,this['_sessionType']=_0x3b3f0b,this['_handlers']=new Map(),this['_eventsQueue']=[],this['_isRunning']=!0x1;}async['connect'](_0x1df0da){this['_wsGateway']=_0x1df0da,this['stopListening'](_0x1df0da,'change:state');const _0x6ef76c=new sessionsconnectmessage_1['default'](this['_id'],this['_sessionType']);let _0x451e18;try{const _0x30ebc0=await this['_wsGateway']['_sendRequest'](sessions_1['_SERVICE'],sessionsconnectmessage_1['default']['TYPE'],messagescompressor_1['default']['encode'](_0x6ef76c));_0x451e18=messagescompressor_1['default']['decode'](_0x30ebc0,sessionsconnectresponse_1['default']);}catch(_0x4fbeff){_0x451e18=new sessionsconnectresponse_1['default'](this['_id'],[]);}this['_connectToChannel'](this['_wsGateway'],_0x451e18['channel'],this['_sessionType']);const _0x15b862=await async function(_0x38b5bc,_0x50d565){const _0x581c7a=_0x50d565['map'](_0x16cde6=>_0x16cde6['userId']),_0x345520=_0x581c7a['length']?await user_1['default']['getMany'](_0x38b5bc,_0x581c7a):[];return _0x50d565['map'](_0x598b9d=>{const _0x4d5f93={'id':_0x598b9d['id'],'role':_0x598b9d['role'],'permissions':_0x598b9d['permissions']};return _0x4d5f93['user']=_0x598b9d['userId']&&_0x345520['find'](_0x4b009e=>_0x4b009e['id']===_0x598b9d['userId'])||new user_1['default'](),_0x4d5f93;});}(this['_wsGateway'],_0x451e18['sockets']);for(const _0x152c75 of _0x15b862)super['add'](_0x152c75);this['_connected']=!0x0,this['fire']('connected'),this['listenTo'](this['_wsGateway'],'change:state',(_0x1ad675,_0x121f50,_0x5b3638)=>this['_onWsGatewayStateChange'](_0x5b3638),{'priority':websocketgateway_1['default']['_CHANGE_STATE_EVENT_PRIORITY']}),await this['_runQueue']();}['disconnect'](_0x54d7cc=!0x0){if(this['_connected']){for(this['_connected']=!0x1,this['_eventsQueue']=[];this['length'];)super['remove'](0x0);this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_wsGateway']&&_0x54d7cc&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['fire']('disconnected'),_0x54d7cc&&this['stopListening']();}}['add'](_0x28df94,_0x42cac7){throw new TypeError('The\x20collection\x20is\x20read-only.');}['remove'](_0x943628){throw new TypeError('The\x20collection\x20is\x20read-only.');}['_connectToChannel'](_0x23a872,_0xa17b50,_0x3ec891){this['_channel']=_0x23a872['_getChannel'](_0x3ec891,_0xa17b50),this['_channel']&&(this['_addHandler'](this['_channel'],socketconnectmessage_1['default']['TYPE'],async _0x40af1a=>{const _0x50c41d=messagescompressor_1['default']['decode'](_0x40af1a,socketconnectmessage_1['default']);if(-0x1===this['getIndex'](_0x50c41d['id'])){const _0x2f9d24={'id':_0x50c41d['id'],'role':_0x50c41d['role'],'permissions':_0x50c41d['permissions']};_0x50c41d['userId']&&(_0x2f9d24['user']=await user_1['default']['get'](_0x23a872,_0x50c41d['userId'])),super['add'](_0x2f9d24);}}),this['_addHandler'](this['_channel'],socketdisconnectmessage_1['default']['TYPE'],_0x5e254b=>{const _0x487f4c=messagescompressor_1['default']['decode'](_0x5e254b,socketdisconnectmessage_1['default']);-0x1!==this['getIndex'](_0x487f4c['id'])&&super['remove'](_0x487f4c['id']);}));}async['_onWsGatewayStateChange'](_0x2837b1){_0x2837b1===websocketgateway_1['default']['STATE_DISCONNECTED']&&this['disconnect'](!0x1),_0x2837b1===websocketgateway_1['default']['STATE_CONNECTED']&&await this['connect'](this['_wsGateway']);}async['_runQueue'](){if(this['_isRunning']||!this['_connected'])return;let _0x4dbfb7;for(this['_isRunning']=!0x0;_0x4dbfb7=this['_eventsQueue']['shift']();){const _0x48685a=this['_handlers']['get'](_0x4dbfb7['eventName']);_0x48685a&&await _0x48685a(_0x4dbfb7['data']);}this['_isRunning']=!0x1;}['_addHandler'](_0x269c6c,_0x1f6bb2,_0x1dd946){const _0x50988f=_0x269c6c['getEventName'](_0x1f6bb2,!0x0);this['listenTo'](_0x269c6c,_0x50988f,async(_0x5cbcb7,_0x521420)=>{const _0x2557a5=_0x5cbcb7['name'];this['_eventsQueue']['push']({'eventName':_0x2557a5,'data':_0x521420}),await this['_runQueue']();}),this['_handlers']['set'](_0x50988f,_0x1dd946);}}exports['default']=SessionCollection;