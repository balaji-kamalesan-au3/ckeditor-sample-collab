/*
 *             Copyright (c) 2016 - 2022, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';var __importDefault=this&&this['__importDefault']||function(_0x1d9d6b){return _0x1d9d6b&&_0x1d9d6b['__esModule']?_0x1d9d6b:{'default':_0x1d9d6b};};Object['defineProperty'](exports,'__esModule',{'value':!0x0}),exports['WEB_SOCKET_GATEWAY_STATES']=void 0x0;const socket_io_client_1=require('socket.io-client'),url_parse_1=__importDefault(require('url-parse')),utils_1=require('ckeditor5/src/utils'),channel_1=__importDefault(require('./channel')),user_1=__importDefault(require('./../users/user')),version_1=__importDefault(require('./../version')),ckeditorcloudserviceserror_1=__importDefault(require('./../ckeditorcloudserviceserror')),ckeditorcloudservicesservererror_1=__importDefault(require('./../ckeditorcloudservicesservererror')),parser_1=require('./parser/parser'),requestsmanager_1=__importDefault(require('./requestsmanager'));var WEB_SOCKET_GATEWAY_STATES;!function(_0x42b08e){_0x42b08e['DISCONNECTED']='disconnected',_0x42b08e['CONNECTING']='connecting',_0x42b08e['CONNECTED']='connected';}(WEB_SOCKET_GATEWAY_STATES=exports['WEB_SOCKET_GATEWAY_STATES']||(exports['WEB_SOCKET_GATEWAY_STATES']={}));class WebSocketGateway{constructor(_0x4c65b6,_0x3244bd,_0x882256={},_0x268873=socket_io_client_1['io'],_0x33ead1=user_1['default']['get']){if(this['_token']=_0x3244bd,this['_options']=_0x882256,this['_connectionProvider']=_0x268873,this['_userFactory']=_0x33ead1,this['_requestsManager']=new requestsmanager_1['default'](this),this['_channels']=new Map(),this['_connectionAttempt']=0x0,!_0x4c65b6)throw new TypeError('Api\x20address\x20must\x20be\x20provided.');if(!this['_token'])throw new TypeError('Token\x20must\x20be\x20provided.');this['_options']['requestTimeout']||(this['_options']['requestTimeout']=0x4e20),this['_url']=(0x0,url_parse_1['default'])(_0x4c65b6['replace'](/^(?!(?:\w+:)?\/\/)/,'https://')),this['set']('state','disconnected'),this['set']('socketId',void 0x0),this['set']('me',void 0x0),this['on']('change:state',async(_0x163484,_0x456edc,_0x43b788)=>{var _0x1b5890;if(_0x43b788!==WebSocketGateway['STATE_CONNECTED']){if(_0x43b788===WebSocketGateway['STATE_DISCONNECTED'])return this['_requestsManager']['errorAll'](new ckeditorcloudserviceserror_1['default']('Not\x20connected.',this));}else try{this['me']=await this['_userFactory']['call'](user_1['default'],this,null===(_0x1b5890=this['_socketAuth'])||void 0x0===_0x1b5890?void 0x0:_0x1b5890['userId']);}catch(_0xf99b63){}},{'priority':WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']}),this['on']('error',(_0x591e50,_0x1ee821)=>{this['_options']['onError']?this['_options']['onError'](_0x1ee821):console['error'](_0x1ee821);});}get['sessionId'](){return this['socketId'];}['disconnect'](){var _0x3b87b8;this['state']!==WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']&&(null===(_0x3b87b8=this['_socket'])||void 0x0===_0x3b87b8||_0x3b87b8['disconnect'](),this['_socket']=void 0x0,this['state']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']);}async['reconnect'](){this['_socket']||this['state']!==WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']||(await this['_token']['refreshToken'](),await this['_connect']());}static async['connect'](_0x3d2ee7,_0xfb77ad='local.cs.dev:443/ws-v2',_0x318d8a={},_0x45b5e4=socket_io_client_1['io'],_0x2ff526=user_1['default']['get']){const _0x21de05=new WebSocketGateway(_0xfb77ad,_0x3d2ee7,_0x318d8a,_0x45b5e4,_0x2ff526);return await _0x21de05['_connect'](),_0x21de05;}['_sendRequest'](_0x488bfe,_0x479209,_0x47b4fe){if(!_0x488bfe)throw new ckeditorcloudserviceserror_1['default']('`serviceName`\x20must\x20be\x20provided.',this);if(this['state']!==WebSocketGateway['STATE_CONNECTED'])throw new ckeditorcloudserviceserror_1['default']('Not\x20connected.',this);if(!this['_socketAuth']||!this['_socketAuth']['isAuthenticated'])throw new ckeditorcloudserviceserror_1['default']('Not\x20authenticated.',this);const _0x2479b2=new ArrayBuffer(_0x47b4fe['length']+0x2),_0x379e51=new Uint8Array(_0x2479b2);return _0x379e51[0x0]=_0x488bfe,_0x379e51[0x1]=parseInt(_0x479209),_0x379e51['set'](_0x47b4fe,0x2),this['_emit'](0x1,_0x379e51);}['_getChannel'](_0x413649,_0x328e08){const _0x1ad851=''+_0x413649+_0x328e08;return!this['_channels']['has'](_0x1ad851)&&this['_socket']&&this['_channels']['set'](_0x1ad851,new channel_1['default'](_0x1ad851,this,this['_socket'])),this['_channels']['get'](_0x1ad851);}['_connect'](){return new Promise((_0x4d2b60,_0xf93398)=>{const _0x2f26f4=this['_setupSocket']();!this['socketId']&&_0x2f26f4['io']['on']('reconnect_error',()=>{this['_reconnectionAttemptError'](_0xf93398);}),_0x2f26f4['once']('connect',async()=>{try{await this['_onConnect'](),_0x4d2b60();}catch(_0x497a15){_0xf93398(_0x497a15);}}),_0x2f26f4['connect']();});}['_getPortByProtocol'](_0x2cfbaf){return['http:','ws:']['includes'](_0x2cfbaf)?0x50:0x1bb;}['_setupSocket'](){var _0x133627;if(this['_socket'])return this['_socket'];const _0x161738=this['_url']['port']||this['_getPortByProtocol'](this['_url']['protocol']),_0x5cb4f7=(this['_url']['protocol']||'https:')+'//'+this['_url']['hostname']+':'+_0x161738,_0x2d26b6=this['_connectionProvider'](_0x5cb4f7,{'parser':{'Encoder':parser_1['Encoder'],'Decoder':parser_1['Decoder']},'path':'/ws-v2/ws','transports':['websocket'],'timeout':void 0x0!==this['_options']['timeout']?this['_options']['timeout']:0x1388,'reconnection':void 0x0===this['_options']['autoReconnect']||this['_options']['autoReconnect'],'reconnectionDelay':0x3e8,'reconnectionDelayMax':0x1388,'rejectUnauthorized':void 0x0===this['_options']['rejectUnauthorized']||this['_options']['rejectUnauthorized'],'query':{'version':version_1['default']},'agent':null!==(_0x133627=this['_options']['agent'])&&void 0x0!==_0x133627&&_0x133627,'closeOnBeforeunload':!0x1});return this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],_0x2d26b6['on']('connect',()=>{this['socketId']=_0x2d26b6['id'];}),_0x2d26b6['on']('connect_error',this['_onError']['bind'](this)),_0x2d26b6['on']('disconnect',this['_onDisconnect']['bind'](this)),_0x2d26b6['io']['on']('reconnect',this['_onReconnect']['bind'](this)),_0x2d26b6['io']['on']('reconnect_attempt',_0x5a2de2=>{this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],this['_connectionAttempt']=_0x5a2de2;}),_0x2d26b6['on']('unauthorized',this['_onUnauthorized']['bind'](this)),this['_socket']=_0x2d26b6,_0x2d26b6;}['_emit'](_0x27e236,_0x28a167){const _0x2155e3=this['_socket'];return this['_requestsManager']['send'](_0x3f20f7=>{_0x2155e3['emit'](_0x27e236,_0x28a167,(_0x1e7ff2,_0x5ad3e3)=>{if(_0x1e7ff2)return _0x3f20f7['error'](ckeditorcloudservicesservererror_1['default']['fromPublicError'](_0x1e7ff2));_0x3f20f7['response'](_0x5ad3e3);});},this['_options']['requestTimeout']);}['_addAuthData'](_0xb97350,_0x2769c8){this['_socketAuth']={'environmentId':_0xb97350,'userId':_0x2769c8,'isAuthenticated':!0x0};}['_removeAuthData'](){this['_socketAuth']=void 0x0;}async['_onConnect'](){await this['_authenticate'](this['_token']['value']),this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTED'];const _0x44c881=async(_0x352994,_0xc6a7d0,_0x253f85)=>{try{await this['_authenticate'](_0x253f85);}catch(_0x31c710){}};this['_token']['on']('change:value',_0x44c881),this['_socket']['io']['off']('reconnect_error'),this['on']('disconnect',()=>{this['_token']['off']('change:value',_0x44c881);});}async['_onReconnect'](){await this['_token']['refreshToken'](),await this['_onConnect']();}['_onDisconnect'](){this['state']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED'],this['_connectionAttempt']=0x0,this['fire']('disconnect');for(const _0xeb871c of this['_channels']['values']())_0xeb871c['remove']();this['_channels']['clear'](),void 0x0===this['_options']['autoReconnect']||this['_options']['autoReconnect']||(this['_socket']=void 0x0);}['_onError'](_0x32007a){console['warn']('Connection\x20to\x20WebSocket\x20server\x20failed.\x20Details:\x20',{'originalError':_0x32007a});}['_reconnectionAttemptError'](_0x5ce34d){this['_connectionAttempt']>=0x2&&(this['disconnect'](),_0x5ce34d(ckeditorcloudserviceserror_1['default']['fromPublicError']({'message':'The\x20number\x20of\x20initial\x20connection\x20attempts\x20exceeded.','explanation':'Three\x20initial\x20connection\x20attempts\x20failed.\x20It\x20can\x20be\x20caused\x20by\x20a\x20missing\x20or\x20blocked\x20Internet\x20connection.','action':'Please\x20verify\x20the\x20stability\x20of\x20your\x20Internet\x20connection\x20and\x20ensure\x20that\x20no\x20antivirus\x20or\x20firewall\x20software\x20blocks\x20the\x20Web\x20Socket\x20protocol\x20connections.'})));}['_onUnauthorized']({error:error}){this['_removeAuthData'](),this['fire']('error',ckeditorcloudservicesservererror_1['default']['fromPublicError'](error));}async['_authenticate'](_0x33d10c){try{const _0x5b3b9e=await this['_emit'](0x2,{'token':_0x33d10c});this['_addAuthData'](_0x5b3b9e['environmentId'],_0x5b3b9e['userId']);}catch(_0x45c1f4){throw this['_removeAuthData'](),_0x45c1f4;}}}WebSocketGateway['STATE_DISCONNECTED']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED'],WebSocketGateway['STATE_CONNECTING']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],WebSocketGateway['STATE_CONNECTED']=WEB_SOCKET_GATEWAY_STATES['CONNECTED'],WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']=utils_1['priorities']['get']('highest')+0xf423f,(0x0,utils_1['mix'])(WebSocketGateway,utils_1['ObservableMixin']),exports['default']=WebSocketGateway;